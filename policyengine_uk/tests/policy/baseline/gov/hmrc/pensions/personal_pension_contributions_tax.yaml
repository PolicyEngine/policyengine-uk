# Tests for personal_pension_contributions_tax (Annual Allowance charge)
# Per Finance Act 2004 s.227 and s.233, the annual allowance charge applies
# to total pension input amounts exceeding the annual allowance.
# The pension input amount includes employer contributions (s.233(1)(b)).
# https://www.legislation.gov.uk/ukpga/2004/12/section/227
# https://www.legislation.gov.uk/ukpga/2004/12/section/233
#
# The pension annual allowance parameter is 40_000 for 2024.

- name: Contributions within annual allowance - no tax charge
  period: 2024
  absolute_error_margin: 0.01
  input:
    employment_income: 80_000
    employee_pension_contributions_reported: 10_000
    personal_pension_contributions: 5_000
    employer_pension_contributions: 5_000
  output:
    # Total for AA: 10_000 + 5_000 + 5_000 = 20_000, below 40_000 AA
    personal_pension_contributions_tax: 0

- name: Employee-only contributions exceeding AA
  period: 2024
  absolute_error_margin: 0.01
  input:
    employment_income: 100_000
    employee_pension_contributions_reported: 70_000
  output:
    # Total for AA: 70_000, excess = 70_000 - 40_000 = 30_000
    # taxed_income ~47_430, marginal rate = 40%
    # Tax charge: 30_000 * 0.4 = 12_000
    personal_pension_contributions_tax: 12_000

- name: Employer contributions push total over AA
  period: 2024
  absolute_error_margin: 0.01
  input:
    employment_income: 100_000
    employee_pension_contributions_reported: 20_000
    employer_pension_contributions: 50_000
  output:
    # Total for AA: 20_000 + 50_000 = 70_000, excess = 70_000 - 40_000 = 30_000
    # taxed_income ~67_430, marginal rate = 40%
    # Tax charge: 30_000 * 0.4 = 12_000
    personal_pension_contributions_tax: 12_000

- name: Only employer contributions exceed AA
  period: 2024
  absolute_error_margin: 0.01
  input:
    employment_income: 100_000
    employer_pension_contributions: 70_000
  output:
    # Total for AA: 70_000 (all employer), excess = 70_000 - 40_000 = 30_000
    # taxed_income ~87_430, marginal rate = 40%
    # Tax charge: 30_000 * 0.4 = 12_000
    personal_pension_contributions_tax: 12_000
